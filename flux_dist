import pandas as pd 
import seaborn as sns
import cobra
import os
from scipy.spatial.distance import pdist, euclidean, cosine, squareform
from functions import load_library, embed
from matplotlib.pyplot import show


path_MM = '/home/acabbia/Documents/Muscle_Model/models/muscle_old_sedentary_trained/'
path_ref_MM = '/home/acabbia/Documents/Muscle_Model/models/recon2.2.xml'
ref_model = cobra.io.read_sbml_model(path_ref_MM)
rxn, met, gen, graphlist, flx = load_library(path_MM, ref_model, sampling = False, FBA=True)
# substitute NaN's with 0
flx.fillna(value=0,inplace =True)
# load label
label = pd.Series([s.split('_')[2] for s in sorted(os.listdir(path_MM))])
#flx = pd.read_csv('sampled_fluxes.csv', index_col='Unnamed: 0') 

#### compute 3 pw distance matrices
flx_eucl = pd.DataFrame(squareform(pdist(flx.T, metric=euclidean)),
                      index=flx.columns, columns=flx.columns)
#normalize in range [0,1]
flx_eucl = flx_eucl / flx_eucl.max().max()

flx_cos = pd.DataFrame(squareform(pdist(smpl.T, metric=cosine)),
                      index=flx.columns, columns=flx.columns)

flx_corr = flx.corr()

# heatmaps
sns.clustermap(flx_eucl)
sns.clustermap(flx_cos)
sns.clustermap(flx_corr)

# k-PCAs
for m in [flx_eucl, flx_cos, flx_corr]:

    e = embed(m,'KernelPCA')
    ax = sns.scatterplot(x=e.iloc[:, 0], y=e.iloc[:, 1], hue=label, s=70)
    show()